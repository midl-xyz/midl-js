{"version":3,"file":"826.1e61546d.chunk.js","mappings":"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","sources":["webpack:///./src/app/pages/rpc-sign-bip322-message/use-sign-bip322-message.ts","webpack:///./src/app/pages/rpc-sign-bip322-message/rpc-sign-bip322-message.tsx"],"sourcesContent":["import { useMemo, useState } from 'react';\n\nimport { PaymentTypes, RpcErrorCode } from '@btckit/types';\nimport * as btc from '@scure/btc-signer';\nimport * as bitcoin from 'bitcoinjs-lib';\n\nimport { signBip322MessageSimple } from '@leather.io/bitcoin';\n\nimport { logger } from '@shared/logger';\nimport { makeRpcErrorResponse, makeRpcSuccessResponse } from '@shared/rpc/rpc-methods';\nimport { closeWindow, createDelay } from '@shared/utils';\nimport { analytics } from '@shared/utils/analytics';\n\nimport { useDefaultRequestParams } from '@app/common/hooks/use-default-request-search-params';\nimport { initialSearchParams } from '@app/common/initial-search-params';\nimport { useToast } from '@app/features/toasts/use-toast';\nimport { useSignBitcoinTx } from '@app/store/accounts/blockchain/bitcoin/bitcoin.hooks';\nimport {\n  useCurrentAccountNativeSegwitSigner,\n  useCurrentNativeSegwitAccount,\n} from '@app/store/accounts/blockchain/bitcoin/native-segwit-account.hooks';\nimport {\n  useCurrentAccountTaprootSigner,\n  useCurrentTaprootAccount,\n} from '@app/store/accounts/blockchain/bitcoin/taproot-account.hooks';\nimport { useCurrentNetwork } from '@app/store/networks/networks.selectors';\n\nfunction useRpcSignBitcoinMessage() {\n  const defaultParams = useDefaultRequestParams();\n  return useMemo(\n    () => ({\n      ...defaultParams,\n      requestId: initialSearchParams.get('requestId') ?? '',\n      message: initialSearchParams.get('message') ?? '',\n      paymentType: (initialSearchParams.get('paymentType') ?? 'p2wpkh') as Extract<\n        'p2tr' | 'p2wpkh',\n        PaymentTypes\n      >,\n    }),\n    [defaultParams]\n  );\n}\n\nconst shortPauseBeforeToast = createDelay(250);\nconst allowTimeForUserToReadToast = createDelay(1200);\n\ninterface SignBip322MessageFactoryArgs {\n  address: string;\n  signPsbt(a: bitcoin.Psbt): Promise<btc.Transaction>;\n}\nfunction useSignBip322MessageFactory({ address, signPsbt }: SignBip322MessageFactoryArgs) {\n  const network = useCurrentNetwork();\n\n  const [isLoading, setIsLoading] = useState(false);\n  const toast = useToast();\n\n  const { tabId, origin, requestId, message } = useRpcSignBitcoinMessage();\n\n  return {\n    origin,\n    message,\n    isLoading,\n    formattedOrigin: new URL(origin ?? '').host,\n    address,\n    onUserRejectBip322MessageSigningRequest() {\n      if (!tabId) return;\n      chrome.tabs.sendMessage(\n        tabId,\n        makeRpcErrorResponse('signMessage', {\n          id: requestId,\n          error: {\n            code: RpcErrorCode.USER_REJECTION,\n            message: 'User rejected message signing request',\n          },\n        })\n      );\n      closeWindow();\n    },\n    async onUserApproveBip322MessageSigningRequest() {\n      setIsLoading(true);\n\n      if (!tabId || !origin) {\n        logger.error('Cannot give app accounts: missing tabId, origin');\n        return;\n      }\n\n      const { signature } = await signBip322MessageSimple({\n        message,\n        address,\n        signPsbt,\n        network: network.chain.bitcoin.mode,\n      });\n\n      await shortPauseBeforeToast();\n      toast.success('Message signed successfully');\n\n      chrome.tabs.sendMessage(\n        tabId,\n        makeRpcSuccessResponse('signMessage', {\n          id: requestId,\n          result: { signature, address, message },\n        })\n      );\n\n      void analytics.track('user_approved_message_signing', { origin });\n\n      await allowTimeForUserToReadToast();\n      closeWindow();\n    },\n  };\n}\n\nfunction useSignBip322MessageTaproot() {\n  const createTaprootSigner = useCurrentAccountTaprootSigner();\n  if (!createTaprootSigner) throw new Error('No taproot signer for current account');\n  const currentTaprootAccount = useCurrentTaprootAccount();\n  if (!currentTaprootAccount) throw new Error('No keychain for current account');\n  const sign = useSignBitcoinTx();\n  const signer = createTaprootSigner(0);\n\n  async function signPsbt(psbt: bitcoin.Psbt) {\n    psbt.data.inputs.forEach(\n      input => (input.tapInternalKey = Buffer.from(signer.payment.tapInternalKey))\n    );\n    return sign(psbt.toBuffer());\n  }\n\n  return useSignBip322MessageFactory({ address: signer.payment.address ?? '', signPsbt });\n}\n\nfunction useSignBip322MessageNativeSegwit() {\n  const createNativeSegwitSigner = useCurrentAccountNativeSegwitSigner();\n  if (!createNativeSegwitSigner) throw new Error('No native segwit signer for current account');\n\n  const currentNativeSegwitAccount = useCurrentNativeSegwitAccount();\n  if (!currentNativeSegwitAccount) throw new Error('No keychain for current account');\n  const sign = useSignBitcoinTx();\n\n  const signer = createNativeSegwitSigner(0);\n\n  async function signPsbt(psbt: bitcoin.Psbt) {\n    return sign(psbt.toBuffer());\n  }\n\n  return useSignBip322MessageFactory({\n    address: signer.payment.address ?? '',\n    signPsbt,\n  });\n}\n\nexport function useSignBip322Message() {\n  const { paymentType } = useRpcSignBitcoinMessage();\n\n  const taprootMsgSigner = useSignBip322MessageTaproot();\n  const nativeSegwitMsgSigner = useSignBip322MessageNativeSegwit();\n\n  switch (paymentType) {\n    case 'p2tr':\n      return taprootMsgSigner;\n    case 'p2wpkh':\n      return nativeSegwitMsgSigner;\n  }\n}\n","import { useEffect, useState } from 'react';\nimport { Outlet, useLocation } from 'react-router-dom';\n\nimport { truncateMiddle } from '@leather.io/utils';\n\nimport { closeWindow } from '@shared/utils';\n\nimport { Disclaimer } from '@app/components/disclaimer';\nimport { NoFeesWarningRow } from '@app/components/no-fees-warning-row';\nimport { PopupHeader } from '@app/features/container/headers/popup.header';\nimport { MessagePreviewBox } from '@app/features/message-signer/message-preview-box';\nimport { MessageSigningRequestLayout } from '@app/features/message-signer/message-signing-request.layout';\nimport { AccountGate } from '@app/routes/account-gate';\nimport { useCurrentNetwork } from '@app/store/networks/networks.selectors';\n\nimport { MessageSigningHeader } from '../../features/message-signer/message-signing-header';\nimport { SignMessageActions } from '../../features/message-signer/stacks-sign-message-action';\nimport { useSignBip322Message } from './use-sign-bip322-message';\n\n// Imported dynamically\n// ts-unused-exports:disable-next-line\nexport function RpcSignBip322MessageRoute() {\n  return (\n    <AccountGate>\n      <RpcSignBip322Message />\n    </AccountGate>\n  );\n}\n\nfunction RpcSignBip322Message() {\n  const {\n    origin,\n    message,\n    address,\n    isLoading: signBip322MessageIsLoading,\n    onUserApproveBip322MessageSigningRequest,\n    onUserRejectBip322MessageSigningRequest,\n  } = useSignBip322Message();\n\n  const location = useLocation();\n  const { chain } = useCurrentNetwork();\n\n  const [isLoading, setIsLoading] = useState(false);\n\n  // if user has wentBack need to stop button loading so they can retry\n  useEffect(() => {\n    if (location?.state?.wentBack) {\n      setIsLoading(false);\n    } else {\n      setIsLoading(signBip322MessageIsLoading);\n    }\n  }, [location, signBip322MessageIsLoading, isLoading, setIsLoading]);\n\n  if (origin === null) {\n    closeWindow();\n    throw new Error('Origin is null');\n  }\n\n  return (\n    <>\n      <Outlet />\n      <PopupHeader showSwitchAccount balance=\"all\" />\n      <MessageSigningRequestLayout>\n        <MessageSigningHeader\n          origin={origin}\n          additionalText={`. This message is signed by ${truncateMiddle(address)}`}\n        />\n        <MessagePreviewBox message={message} />\n        <NoFeesWarningRow chainId={chain.stacks.chainId} />\n        <SignMessageActions\n          isLoading={isLoading}\n          onSignMessage={() => onUserApproveBip322MessageSigningRequest()}\n          onSignMessageCancel={() => onUserRejectBip322MessageSigningRequest()}\n        />\n        <hr />\n        <Disclaimer\n          disclaimerText=\"By signing this message, you prove that you own this address\"\n          mb=\"space.05\"\n        />\n      </MessageSigningRequestLayout>\n    </>\n  );\n}\n"],"names":[],"sourceRoot":""}